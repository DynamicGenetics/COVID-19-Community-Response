<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="./semantic/semantic.min.css">
    <link rel="stylesheet" href="./css/scatterplot.css">
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css' rel='stylesheet' />
    <script src="./js/mapbox-access-token.js"></script>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script> -->
    <script src="./semantic/semantic.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/d3-regression@1.3.4/dist/d3-regression.min.js"></script>
    <script src="./js/cc.js"></script>
    <title>COVID-19 Community Response Map</title>
  </head>
  <body>
    <div id="content">
      <div id="map"></div>
      <div id="sidebar">
        <!-- <h3>COVID-19 Community Response</h3> -->
        <svg id="plot-area"></svg>
        <div id="support_area">
          <div class="ui multiple fluid selection dropdown" id="multi-select_support">
          <!-- This will receive comma separated value like OH,TX,WY !-->
            <input name="support" type="hidden" value="">
            <div class="text"></div>
            <i class="dropdown icon"></i>
            <div id="support_menu" class="menu">
            </div>
          </div>
        </div>
        <div id="needs_area">
          <div class="ui multiple fluid selection dropdown" id="multi-select_needs">
          <!-- This will receive comma separated value like OH,TX,WY !-->
            <input name="need" type="hidden" value="">
            <div class="text"></div>
            <i class="dropdown icon"></i>
            <div id="needs_menu" class="menu">
            </div>
          </div>
        </div>

    <script>

      // Set up sidebar
      const sidebarWidth = 400;

      // Opener / closer for sidebar
      const addToggle = cc.getToggleAdder();
      addToggle("div#sidebar", sidebarWidth);

      // Automatically close sidebar on smaller screens
      const mq = window.matchMedia("(max-width: 813px)");
      if (mq.matches) {
          const b = document.getElementById('opener');
          let evt = new MouseEvent("click");
          b.dispatchEvent(evt);
      }

      // Set up plotting area
      const width=380;
      const height=380;
      const margin = ({top: 30, right: 20, bottom: 40, left: 40});

      // Load data for x and y and wait for both
      // const x_promise = d3.csv("./data/covidCases_phw.csv", function(d, i) {return {lad18nm: d.lad18nm, areaID: d.areaID, x: +d.value};});
      // const y_promise = d3.csv("./data/censusData_comm.csv", function(d, i) {return {lad18nm: d.lad18nm, areaID: d.areaID, y: +d.value};});

      // Load json data structure
      const data_promise = d3.json("./data/dummy.json");

      // Map boundaries data
      const promiseLA = d3.json("./data/boundaries_LAs.geojson");

      Promise.all([data_promise, promiseLA]).then( data => {

        let boundaries;
        [data, boundaries] = data;

        console.log(data);

        const supports = data.variables.filter(d => d.class === "support");
        const needs = data.variables.filter(d => d.class === "challenge");

        d3.select("#multi-select_support input").property("value", supports[0].name);
        console.log(supports.map(d => {return {name: d.label, value: d.name}}));
        const support_menu = d3.select("#support_menu");
        supports.forEach(element => {
          support_menu.append("div").attr("class", "item").attr("data-value", element.name).html(element.label);
        });


        d3.select("#multi-select_needs input").property("value", needs[0].name);
        const needs_menu = d3.select("#needs_menu");
        needs.forEach(element => {
          needs_menu.append("div").attr("class", "item").attr("data-value", element.name).html(element.label);
        });


        let chosen_supports = [supports[0].name];
        let chosen_needs = [needs[0].name];
        // let chosen_needs = needs.map(d => d.name);
        // let chosen_needs = [];
        // let chosen_supports = [];

        console.log(supports);
        console.log(needs);

        data = data.LAs;
        let LSOAs = data.LSOAs;

        // Set up map
        let map = new mapboxgl.Map({
          container: 'map',
          style: "mapbox://styles/oliverdavis/ck9q4pu7o5j4a1ipdqsxrusj2",
          center: [-3.766409, 52.33022],
          zoom: 7
        });

        // Draw scatter plot
        // cc.drawScatterplot("#plot-area", x_var, y_var, data, height, width, margin, map, boundaries);

        // Draw beeswarm plot
        // cc.drawBeeswarm("#plot-area", x_var, data, height, width, margin, map, boundaries);

        // // Calculate variables and redraw plot, recolour map
        // cc.redraw("#plot-area", chosen_supports, chosen_needs, data, height, width, margin, map, boundaries);

        // Remember the latest hovered map area
        let hoveredArea = null;

        map.on('load', function () {

          map.addSource("boundaries_LAs", {
            "type": "geojson",
            "data": boundaries,
            "generateId": true
          });
          map.addLayer({
            "id": "local_authorities",
            "type": "fill",
            "source": "boundaries_LAs",
            "layout": {},
            "paint": {
              'fill-color': ["get","colour"],
              'fill-opacity': ['interpolate', ["exponential", 3], ['zoom'], 7, 0.6, 11, 0.2]
            }
          }, "settlement-minor-label");

          map.addLayer({
            "id": "lA_borders",
            "type": "line",
            "source": "boundaries_LAs",
            "layout": {},
            "paint": {
              "line-color": "#505050",
              "line-width": [
                "case",
                ["boolean", ["feature-state", "hover"], false],
                2,
                0.5
              ]
            }
          }, "settlement-minor-label");

          cc.redraw("#plot-area", chosen_supports, chosen_needs, data, height, width, margin, map, boundaries);

          // Hillshade layer (optional)
          // map.addSource('dem', {'type': 'raster-dem','url': 'mapbox://mapbox.terrain-rgb'});
          // map.addLayer({
          //   'id': 'hillshading',
          //   'source': 'dem',
          //   'type': 'hillshade'
          //   // insert below waterway-river-canal-shadow;
          //   // where hillshading sits in the Mapbox Outdoors style
          // }, 'waterway-shadow');

          map.on('mouseover', "local_authorities", function(e) {
      		// Change the cursor style as a UI indicator.
      			map.getCanvas().style.cursor = 'pointer';
      		});

          map.on("mousemove", "local_authorities", function(e) {
            if (e.features.length > 0) {
              if (hoveredArea !== undefined) {
                map.setFeatureState(
                  {source: "boundaries_LAs", id: hoveredArea},
                  {hover: false}
                );
                if(e.features[0].id != hoveredArea){
                  d3.selectAll("circle.datapoints")
                    .transition().duration(50)
                    .attr("r", "7").attr("stroke-width", 1.5);
                }
              }
              hoveredArea = e.features[0].id;
              map.setFeatureState(
                {source: "boundaries_LAs", id: hoveredArea},
                {hover: true}
              );
              d3.select("circle#" + e.features[0].properties.lad18cd)
                .transition().duration(50)
                .attr("r", "12").attr("stroke-width", 2);
            }
          });

          map.on('mouseleave', "local_authorities", function(e) {
      			map.getCanvas().style.cursor = '';
            if(hoveredArea !== undefined) {
              map.setFeatureState(
                {source: "boundaries_LAs", id: hoveredArea},
                {hover: false}
              );
              d3.selectAll("circle.datapoints")
                .transition().duration(50)
                .attr("r", "7").attr("stroke-width", 1.5);
            }
            hoveredArea = null;
      		});

        });

        // Set up variable selection drop-downs
        $('#multi-select_support')
          .dropdown({
            onChange: handleSelectionChange
          });
        $('#multi-select_support').dropdown('set value', supports[0].name);

        $('#multi-select_needs')
          .dropdown({
            onChange: handleSelectionChange
          });

        // Redraw when the selected variables change
        function handleSelectionChange(value, text, $selectedItem) {
          console.log("redrawing");
          console.log(d3.select("#multi-select_support input").property("value").split(','));
          console.log(d3.select("#multi-select_needs input").property("value").split(','));

          chosen_supports = d3.select("#multi-select_support input").property("value").split(',');
          if(chosen_supports[0] === ""){
            chosen_supports = [];
          }
          chosen_needs = d3.select("#multi-select_needs input").property("value").split(',');
          if(chosen_needs[0] === ""){
            chosen_needs = [];
          }
          cc.redraw("#plot-area", chosen_supports, chosen_needs, data, height, width, margin, map, boundaries);
        }


      });




    </script>
  </body>
</html>
