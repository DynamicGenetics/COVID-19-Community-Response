<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="./css/scatterplot.css">
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css' rel='stylesheet' />
    <script src="./js/mapbox-access-token.js"></script>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <!-- <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script> -->
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/d3-regression@1.3.4/dist/d3-regression.min.js"></script>
    <script src="./js/cc.js"></script>
    <title>Scatterplot</title>
  </head>
  <body>
    <div id="content">
      <div id="map"></div>
      <div id="sidebar">
        <svg id="plot-area">
      </div>
    </div>

    <script>

      // Set up sidebar
      const sidebarWidth = 400;

      // Opener / closer for sidebar
      const addToggle = cc.getToggleAdder();
      addToggle("div#sidebar", sidebarWidth);

      // Automatically close sidebar on smaller screens
      const mq = window.matchMedia("(max-width: 813px)");
      if (mq.matches) {
          const b = document.getElementById('opener');
          let evt = new MouseEvent("click");
          b.dispatchEvent(evt);
      }

      // Set up plotting area
      const width=380;
      const height=380;
      const margin = ({top: 30, right: 20, bottom: 40, left: 40});

      // Load data for x and y and wait for both
      // const x_promise = d3.csv("./data/covidCases_phw.csv", function(d, i) {return {lad18nm: d.lad18nm, areaID: d.areaID, x: +d.value};});
      // const y_promise = d3.csv("./data/censusData_comm.csv", function(d, i) {return {lad18nm: d.lad18nm, areaID: d.areaID, y: +d.value};});

      // Load json data structure
      const data_promise = d3.json("./data/dummy.json");

      // Map boundaries data
      const promiseLA = d3.json("./data/boundaries_LAs.geojson");

      // Promise.all([x_promise, y_promise, promiseLA]).then( data => {
      Promise.all([data_promise, promiseLA]).then( data => {

        // let x_data, y_data, boundaries;
        // [x_data, y_data, boundaries] = data;

        let boundaries;
        [data, boundaries] = data;

        // // Merge x and y into the same data frame
        // data = [];
        //
        // if(x_data.length === y_data.length){
        //   for (let i = 0; i < x_data.length; i++) {
        //     let found = y_data.find(element => {return element.areaID === x_data[i].areaID});
        //     data[i] = Object.assign(x_data[i], found);
        //   }
        // } else {
        //   console.log("Location arrays are inconsistent lengths.")
        // };

        console.log(data);

        let supports = data.variables.filter(d => d.class === "support");
        let needs = data.variables.filter(d => d.class === "challenge");

        console.log(supports);
        console.log(needs);

        data = data.LAs;
        let LSOAs = data.LSOAs;

        let x_var = needs[3].name;
        let y_var = supports[0].name;

        // Set up map
        let map = new mapboxgl.Map({
          container: 'map',
          style: "mapbox://styles/oliverdavis/ck9q4pu7o5j4a1ipdqsxrusj2",
          center: [-3.766409, 52.33022],
          zoom: 7
        });

        // Draw scatter plot
        cc.drawScatterplot("#plot-area", x_var, y_var, data, height, width, margin, map, boundaries);

        // Remember the latest hovered map area
        let hoveredArea = null;

        map.on('load', function () {

          map.addSource("boundaries_LAs", {
            "type": "geojson",
            "data": boundaries,
            "generateId": true
          });
          map.addLayer({
            "id": "local_authorities",
            "type": "fill",
            "source": "boundaries_LAs",
            "layout": {},
            "paint": {
              'fill-color': ["get","colour"],
              'fill-opacity': ['interpolate', ["exponential", 3], ['zoom'], 7, 0.6, 11, 0.2]
            }
          }, "settlement-minor-label");

          map.addLayer({
            "id": "lA_borders",
            "type": "line",
            "source": "boundaries_LAs",
            "layout": {},
            "paint": {
              "line-color": "#505050",
              "line-width": [
                "case",
                ["boolean", ["feature-state", "hover"], false],
                2,
                0.5
              ]
            }
          }, "settlement-minor-label");

          // Hillshade layer (optional)
          // map.addSource('dem', {'type': 'raster-dem','url': 'mapbox://mapbox.terrain-rgb'});
          // map.addLayer({
          //   'id': 'hillshading',
          //   'source': 'dem',
          //   'type': 'hillshade'
          //   // insert below waterway-river-canal-shadow;
          //   // where hillshading sits in the Mapbox Outdoors style
          // }, 'waterway-shadow');

          map.on('mouseover', "local_authorities", function(e) {
      		// Change the cursor style as a UI indicator.
      			map.getCanvas().style.cursor = 'pointer';
      		});

          map.on("mousemove", "local_authorities", function(e) {
            if (e.features.length > 0) {
              if (hoveredArea !== undefined) {
                map.setFeatureState(
                  {source: "boundaries_LAs", id: hoveredArea},
                  {hover: false}
                );
                if(e.features[0].id != hoveredArea){
                  d3.selectAll("circle.datapoints")
                    .transition().duration(50)
                    .attr("r", "7").attr("stroke-width", 1.5);
                }
              }
              hoveredArea = e.features[0].id;
              map.setFeatureState(
                {source: "boundaries_LAs", id: hoveredArea},
                {hover: true}
              );
              d3.select("circle#" + e.features[0].properties.lad18cd)
                .transition().duration(50)
                .attr("r", "12").attr("stroke-width", 2);
            }
          });

          map.on('mouseleave', "local_authorities", function(e) {
      			map.getCanvas().style.cursor = '';
            if(hoveredArea !== undefined) {
              map.setFeatureState(
                {source: "boundaries_LAs", id: hoveredArea},
                {hover: false}
              );
              d3.selectAll("circle.datapoints")
                .transition().duration(50)
                .attr("r", "7").attr("stroke-width", 1.5);
            }
            hoveredArea = null;
      		});

        });
      });

    </script>
  </body>
</html>
