<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="./frontend/map/semantic/semantic.min.css">
    <link rel="stylesheet" href="./frontend/map/css/scatterplot.css">
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css' rel='stylesheet' />
    <script src="./frontend/map/js/mapbox-access-token.js"></script>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script> -->
    <script src="./frontend/map/semantic/semantic.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/d3-regression@1.3.4/dist/d3-regression.min.js"></script>
    <script src="./frontend/map/js/cc.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;800&display=swap" rel="stylesheet">
    <title>COVID-19 Community Response Map</title>
  </head>
  <body>
    <div id="content">
      <div id="logo_area"><a href="./index.html"><img id="logo" src="./frontend/map/images/Community_Response_200px.png" alt="COVID-19 Community Response"></a></div>
      <div id="map"></div>
      <div id="sidebar">
        <h3 class="ui dividing header">
          <div class="content">
            COVID-19 Community Response
            <div class="sub header">Citizen-led support in Wales</div>
          </div>
        </h3>
        <svg id="plot-area"></svg>
        <div id="support_area">
          <!-- <h3 class="ui header">Support</h3> -->
          <h4 class="ui horizontal support divider header">
            <i class="arrow circle up icon"></i>
            <div class="content">
              Support
            </div>
          </h4>
          <div class="ui multiple selection dropdown" id="multi-select_support">
          <!-- This will receive comma separated value like OH,TX,WY !-->
            <input name="support" type="hidden" value="">
            <div class="text"></div>
            <i class="dropdown icon"></i>
            <!-- <div class="default text">Select indicators of support...</div> -->
            <div id="support_menu" class="menu">
            </div>
          </div>
        </div>
        <div id="needs_area">
          <!-- <h3 class="ui header">Need</h3> -->
          <h4 class="ui horizontal needs divider header">
              <i class="arrow circle right icon"></i>
              <div class="content">
                Need
              </div>
          </h4>
          <div class="ui multiple selection dropdown" id="multi-select_needs">
          <!-- This will receive comma separated value like OH,TX,WY !-->
            <input name="need" type="hidden" value="">
            <div class="text"></div>
            <i class="dropdown icon"></i>
            <!-- <div class="default text">Select indicators of need...</div> -->
            <div id="needs_menu" class="menu">
            </div>
          </div>
        </div>

    <script>

      // Set up sidebar
      const sidebarWidth = 400;

      // Opener / closer for sidebar
      const addToggle = cc.getToggleAdder();
      addToggle("div#sidebar", sidebarWidth);

      // Automatically close sidebar on smaller screens
      const mq = window.matchMedia("(max-width: 813px)");
      if (mq.matches) {
          const b = document.getElementById('opener');
          let evt = new MouseEvent("click");
          b.dispatchEvent(evt);
      }

      // Set up plotting area
      const width=380;
      const height=380;
      const margin = ({top: 30, right: 20, bottom: 40, left: 40});

      // Load data for x and y and wait for both
      // const x_promise = d3.csv("./data/covidCases_phw.csv", function(d, i) {return {lad18nm: d.lad18nm, areaID: d.areaID, x: +d.value};});
      // const y_promise = d3.csv("./data/censusData_comm.csv", function(d, i) {return {lad18nm: d.lad18nm, areaID: d.areaID, y: +d.value};});

      // Load json data structure
      const data_promise = d3.json("./frontend/map/data/data.json");

      // Map boundaries data
      const promiseLA = d3.json("./frontend/map/data/boundaries_LA.geojson");
      const promiseLSOA = d3.json("./frontend/map/data/boundaries_LSOA.geojson");

      // Load groups data
      const promiseGroups = d3.json("./frontend/map/data/groups.geojson");

      Promise.all([data_promise, promiseLA, promiseLSOA, promiseGroups]).then( data => {

        let LAs, LSOAs, groups;
        [data, LAs, LSOAs, groups] = data;

        console.log(data);

        const supports = data.variables.filter(d => d.class === "support");
        const needs = data.variables.filter(d => d.class === "challenge");

        d3.select("#multi-select_support input").property("value", supports[0].name);
        console.log(supports.map(d => {return {name: d.label, value: d.name}}));
        const support_menu = d3.select("#support_menu");
        supports.forEach(element => {
          support_menu.append("div").attr("class", "item").attr("data-value", element.name).html(element.label);
        });


        d3.select("#multi-select_needs input").property("value", needs[0].name);
        const needs_menu = d3.select("#needs_menu");
        needs.forEach(element => {
          needs_menu.append("div").attr("class", "item").attr("data-value", element.name).html(element.label);
        });


        let chosen_supports = [supports[0].name];
        let chosen_needs = [needs[0].name];
        // let chosen_needs = needs.map(d => d.name);
        // let chosen_needs = [];
        // let chosen_supports = [];

        console.log(supports);
        console.log(needs);

        // data = data.LAs;
        // let LSOAs = data.LSOAs;

        // Set up map
        let map = new mapboxgl.Map({
          container: 'map',
          style: "mapbox://styles/oliverdavis/ck9q4pu7o5j4a1ipdqsxrusj2",
          // style: "mapbox://styles/mapbox/light-v9",
          center: [-3.766409, 52.33022],
          zoom: 7,
          bounds: [
            [-5.437896, 51.349480],
            [-2.487949, 53.460506]
          ]
        });

        // Draw scatter plot
        // cc.drawScatterplot("#plot-area", x_var, y_var, data, height, width, margin, map, boundaries);

        // Draw beeswarm plot
        // cc.drawBeeswarm("#plot-area", x_var, data, height, width, margin, map, boundaries);

        // // Calculate variables and redraw plot, recolour map
        // cc.redraw("#plot-area", chosen_supports, chosen_needs, data, height, width, margin, map, boundaries);

        // Remember the latest hovered map area
        let hoveredArea = null;

        map.on('load', function () {

          map.addSource("boundaries_LAs", {
            "type": "geojson",
            "data": LAs,
            "generateId": true
          });
          map.addLayer({
            "id": "local_authorities",
            "type": "fill",
            "source": "boundaries_LAs",
            "layout": {
    					"visibility": "none"
    				},
            "paint": {
              'fill-color': ["get","colour"],
              'fill-opacity': ['interpolate', ["exponential", 2], ['zoom'], 7, 0.8, 11, 0.2]
            }
          }, "settlement-subdivision-label");
          map.addLayer({
            "id": "LA_borders",
            "type": "line",
            "source": "boundaries_LAs",
            "layout": {
    					"visibility": "none"
    				},
            "paint": {
              "line-color": "#505050",
              "line-width": [
                "case",
                ["boolean", ["feature-state", "hover"], false],
                2,
                0.5
              ]
            }
          }, "settlement-subdivision-label");

          map.addSource("boundaries_LSOAs", {
            "type": "geojson",
            "data": LSOAs,
            "generateId": true
          });
          map.addLayer({
            "id": "lower_super_output_areas",
            "type": "fill",
            "source": "boundaries_LSOAs",
            "layout": {
    					"visibility": "none"
    				},
            "paint": {
              'fill-color': ["get","colour"],
              'fill-opacity': ['interpolate', ["exponential", 6], ['zoom'], 7, 0.8, 11, 0.2]
            }
          }, "settlement-subdivision-label");
          map.addLayer({
            "id": "LSOA_borders",
            "type": "line",
            "source": "boundaries_LSOAs",
            "layout": {
    					"visibility": "none"
    				},
            "paint": {
              "line-color": "#505050",
              "line-width": [
                "case",
                ["boolean", ["feature-state", "hover"], false],
                2,
                0
              ]
            }
          }, "settlement-subdivision-label");

          map.addSource("groups_source", {type: "geojson", data: groups});
    			map.addLayer({
    				"id": "community_groups",
    				"type": "circle",
    				"source": "groups_source",
            "minzoom": 9,
    				"layout": {
    					"visibility": "visible"
    				},
    				"paint": {
    					'circle-radius': ['interpolate', ["exponential", 1.75], ['zoom'], 9, 3, 14, 20],
    					"circle-color": "#747b7b"
    				}
    			}, "settlement-subdivision-label");

          cc.redraw("#plot-area", chosen_supports, chosen_needs, data, height, width, margin, map, LAs, LSOAs);

          // Hillshade layer (optional)
          // map.addSource('dem', {'type': 'raster-dem','url': 'mapbox://mapbox.terrain-rgb'});
          // map.addLayer({
          //   'id': 'hillshading',
          //   'source': 'dem',
          //   'type': 'hillshade'
          //   // insert below waterway-river-canal-shadow;
          //   // where hillshading sits in the Mapbox Outdoors style
          // }, 'waterway-shadow');


          // Local authority mouse events
          map.on('mouseover', "local_authorities", function(e) {
      		// Change the cursor style as a UI indicator.
      			map.getCanvas().style.cursor = 'pointer';
      		});

          map.on("mousemove", "local_authorities", function(e) {
            if (e.features.length > 0) {
              if (hoveredArea !== undefined) {
                map.setFeatureState(
                  {source: "boundaries_LAs", id: hoveredArea},
                  {hover: false}
                );
                if(e.features[0].id != hoveredArea){
                  d3.selectAll("circle.datapoints")
                    .transition().duration(50)
                    .attr("r", "6").attr("stroke-width", 1.5);
                }
              }
              hoveredArea = e.features[0].id;
              map.setFeatureState(
                {source: "boundaries_LAs", id: hoveredArea},
                {hover: true}
              );
              d3.select("circle#" + e.features[0].properties.lad18cd)
                .transition().duration(50)
                .attr("r", "12").attr("stroke-width", 2);
            }
          });

          map.on('mouseleave', "local_authorities", function(e) {
      			map.getCanvas().style.cursor = '';
            if(hoveredArea !== undefined) {
              map.setFeatureState(
                {source: "boundaries_LAs", id: hoveredArea},
                {hover: false}
              );
              d3.selectAll("circle.datapoints")
                .transition().duration(50)
                .attr("r", "6").attr("stroke-width", 1.5);
            }
            hoveredArea = null;
      		});

          // LSOA events
          map.on('mouseover', "lower_super_output_areas", function(e) {
          // Change the cursor style as a UI indicator.
            map.getCanvas().style.cursor = 'pointer';
          });

          map.on("mousemove", "lower_super_output_areas", function(e) {
            if (e.features.length > 0) {
              if (hoveredArea !== undefined) {
                map.setFeatureState(
                  {source: "boundaries_LSOAs", id: hoveredArea},
                  {hover: false}
                );
                if(e.features[0].id != hoveredArea){
                  d3.selectAll("circle.datapoints")
                    .transition().duration(50)
                    .attr("r", "3").attr("stroke-width", 1.5);
                }
              }
              hoveredArea = e.features[0].id;
              map.setFeatureState(
                {source: "boundaries_LSOAs", id: hoveredArea},
                {hover: true}
              );
              d3.select("circle#" + e.features[0].properties.LSOA11CD)
                .transition().duration(50)
                .attr("r", "12").attr("stroke-width", 2);
            }
          });

          map.on('mouseleave', "lower_super_output_areas", function(e) {
            map.getCanvas().style.cursor = '';
            if(hoveredArea !== undefined) {
              map.setFeatureState(
                {source: "boundaries_LSOAs", id: hoveredArea},
                {hover: false}
              );
              d3.selectAll("circle.datapoints")
                .transition().duration(50)
                .attr("r", "3").attr("stroke-width", 1.5);
            }
            hoveredArea = null;
          });

          // Create a popup, but don't add it to the map yet.
        	let popup = new mapboxgl.Popup({
        		closeButton: false,
        		closeOnClick: false
        	});

          map.on("mouseover", "community_groups", function(e) {
          // Change the cursor style as a UI indicator.
            //map.getCanvas().style.cursor = 'pointer';

            let coordinates = e.features[0].geometry.coordinates.slice();
            let description = e.features[0].properties.Title;

            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
              coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }

            // Populate the popup and set its coordinates
            // based on the feature found.
            popup.setLngLat(coordinates)
              .setHTML(description)
              .addTo(map);

          });

          map.on("mouseout", "community_groups", function(e) {
            popup.remove();
          });

        });

        // Set up variable selection drop-downs
        $('#multi-select_support')
          .dropdown({
            onChange: handleSelectionChange
          });
        $('#multi-select_support').dropdown('set value', supports[0].name);

        $('#multi-select_needs')
          .dropdown({
            onChange: handleSelectionChange
          });

        // Redraw when the selected variables change
        function handleSelectionChange(value, text, $selectedItem) {
          console.log("redrawing");
          console.log(d3.select("#multi-select_support input").property("value").split(','));
          console.log(d3.select("#multi-select_needs input").property("value").split(','));

          chosen_supports = d3.select("#multi-select_support input").property("value").split(',');
          if(chosen_supports[0] === ""){
            chosen_supports = [];
          }
          chosen_needs = d3.select("#multi-select_needs input").property("value").split(',');
          if(chosen_needs[0] === ""){
            chosen_needs = [];
          }
          cc.redraw("#plot-area", chosen_supports, chosen_needs, data, height, width, margin, map, LAs, LSOAs);
        }


      });




    </script>
  </body>
</html>
